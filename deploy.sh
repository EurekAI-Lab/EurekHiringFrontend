#!/bin/bash

# å‰ç«¯é¡¹ç›®éƒ¨ç½²è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: sh ./deploy_frontend.sh

echo "ğŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯é¡¹ç›®..."
echo "========================================"

# æ˜¾ç¤ºå½“å‰æ—¶é—´
echo "â° éƒ¨ç½²å¼€å§‹æ—¶é—´: $(date)"

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if [ ! -f "package.json" ]; then
    echo "âŒ é”™è¯¯: å½“å‰ç›®å½•ä¸æ˜¯å‰ç«¯é¡¹ç›®æ ¹ç›®å½•"
    exit 1
fi

# æ£€æŸ¥pnpmæ˜¯å¦å®‰è£…
if ! command -v pnpm &> /dev/null; then
    echo "âŒ é”™è¯¯: pnpm æœªå®‰è£…"
    exit 1
fi

# åˆ›å»ºéƒ¨ç½²ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
if [ ! -d "deploy" ]; then
    echo "ğŸ“ åˆ›å»ºéƒ¨ç½²ç›®å½•..."
    mkdir -p deploy
fi

# æ„å»ºé¡¹ç›®
echo "ğŸ”¨ å¼€å§‹æ„å»º H5 ç‰ˆæœ¬..."
if pnpm build:h5; then
    echo "âœ… æ„å»ºæˆåŠŸ"
else
    echo "âŒ æ„å»ºå¤±è´¥"
    exit 1
fi

# å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
echo "ğŸ“¦ å¤åˆ¶æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•..."
if cp -rf ./dist/build/h5/* deploy/; then
    echo "âœ… æ–‡ä»¶å¤åˆ¶æˆåŠŸ"
else
    echo "âŒ æ–‡ä»¶å¤åˆ¶å¤±è´¥"
    exit 1
fi

# æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
echo "========================================"
echo "âœ… éƒ¨ç½²å®Œæˆ!"
echo "â° éƒ¨ç½²å®Œæˆæ—¶é—´: $(date)"

# æ£€æŸ¥æ„å»ºæ—¶é—´
if [ -f "deploy/index.html" ]; then
    BUILD_TIME=$(grep -o 'build-time="[^"]*"' deploy/index.html | sed 's/build-time="//; s/"//')
    echo "ğŸ—ï¸  æ„å»ºæ—¶é—´: $BUILD_TIME"
    echo "ğŸ“ éƒ¨ç½²ç›®å½•: $(pwd)/deploy/"
fi

# æ˜¾ç¤ºæ–‡ä»¶å¤§å°
echo "ğŸ“Š éƒ¨ç½²æ–‡ä»¶ç»Ÿè®¡:"
du -sh deploy/
ls -la deploy/

echo "========================================"
echo "ğŸ‰ å‰ç«¯é¡¹ç›®éƒ¨ç½²æˆåŠŸï¼"
echo "ğŸ’¡ æç¤º: ç¡®ä¿ä½ çš„ web æœåŠ¡å™¨æŒ‡å‘ deploy/ ç›®å½•"
